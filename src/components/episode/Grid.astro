---
import EpisodeCard from './Card.astro';
import ErrorBoundary from '../common/ErrorBoundary.astro';
import { validateProps, EpisodeGridPropsSchema } from '~/utils/component-validation';

import type { z } from 'zod';
import type { EpisodeGridPropsSchema } from '~/utils/component-validation';

type Props = z.infer<typeof EpisodeGridPropsSchema>;

// Validate props
const props = validateProps(EpisodeGridPropsSchema, Astro.props);
const { 
  episodes,
  limit,
  featured = false,
  columns = '3',
  loading = false
} = props;

console.log('Grid received episodes:', JSON.stringify(episodes, null, 2));

// Filter and sort episodes
let displayEpisodes = [];
try {
  console.log('Grid received episodes:', JSON.stringify(episodes, null, 2));
  displayEpisodes = episodes
    .filter(entry => {
      try {
        console.log('Processing entry:', JSON.stringify(entry, null, 2));
        // Skip if featured filter is on and episode is not featured
        const meetsFeatureFilter = !featured || entry.data.attributes.featured;
        return meetsFeatureFilter;
      } catch (error) {
        console.error('Error processing entry:', error);
        return false;
      }
    })
    // Apply limit if specified
    .slice(0, limit || undefined);

  console.log('Display episodes:', JSON.stringify(displayEpisodes, null, 2));
} catch (error) {
  console.error('Error processing episodes:', error);
}

// Define grid columns class based on prop
const gridClass = {
  '2': 'sm:grid-cols-2',
  '3': 'sm:grid-cols-2 lg:grid-cols-3',
  '4': 'sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'
}[columns];

// Generate skeleton cards for loading state
const skeletonCount = limit || 6;

// Prepare ARIA labels
const gridLabel = featured ? 'Featured Episodes' : 'Episode List';
const loadingLabel = 'Loading episodes...';
const noEpisodesLabel = 'No episodes found';
---

<ErrorBoundary fallback="Unable to load episodes. Please try again later.">
  <div class="episode-grid">
    {loading ? (
      <div 
        role="status" 
        aria-label={loadingLabel}
        class={`grid gap-4 sm:gap-6 ${gridClass}`}
      >
        {Array.from({ length: skeletonCount }).map(() => (
          <EpisodeCard
            episode={{
              id: 'skeleton',
              type: 'episode',
              attributes: {
                title: 'Loading...',
                summary: 'Loading...',
                description: 'Loading...',
                published_at: new Date().toISOString(),
                media_url: '',
                duration: 0,
                duration_in_mmss: '00:00',
                formatted_published_at: 'Loading...',
                formatted_description: 'Loading...',
                share_url: '',
                embed_html: '',
                embed_html_dark: '',
                slug: '',
              },
              relationships: {
                show: {
                  data: {
                    id: '',
                    type: 'show',
                  },
                },
              },
            }}
            loading={true}
          />
        ))}
        <div class="sr-only" aria-live="polite">Loading episodes, please wait...</div>
      </div>
    ) : displayEpisodes.length > 0 ? (
      <div 
        role="grid" 
        aria-label={gridLabel}
        class={`grid gap-4 sm:gap-6 ${gridClass}`}
        data-grid-nav
      >
        {displayEpisodes.map((episode, index) => (
          <div 
            role="gridcell"
            class="episode-cell"
            tabindex={index === 0 ? 0 : -1}
          >
            <EpisodeCard episode={episode.data} />
          </div>
        ))}
      </div>
    ) : (
      <div 
        class="no-episodes"
        role="status"
        aria-label={noEpisodesLabel}
      >
        <p>No episodes found.</p>
      </div>
    )}
  </div>
</ErrorBoundary>

<script>
import { initializeGridNavigation } from './grid-init';
initializeGridNavigation();
</script>

<style>
.episode-grid {
  @apply w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8;
}

.no-episodes {
  @apply text-center text-gray-500 dark:text-gray-400 py-8 sm:py-12;
}

/* Responsive grid adjustments */
@screen sm {
  .grid {
    @apply grid-cols-2;
  }
}

@screen lg {
  .grid {
    @apply grid-cols-3;
  }
}

@screen xl {
  .grid[class*='grid-cols-4'] {
    @apply grid-cols-4;
  }
}

/* Loading state animation */
@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.loading {
  @apply animate-pulse;
}

/* Focus styles */
.episode-cell:focus-within {
  @apply outline-none ring-2 ring-blue-500 ring-offset-2 dark:ring-offset-gray-800 rounded-lg;
}
</style>
